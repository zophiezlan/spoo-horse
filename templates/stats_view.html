<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>{{ json_data["short_code"] }} - Analytics - my.ket.horse</title>

    <!-- Meta Tags -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/favicon.png') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Track link performance, monitor clicks, and gauge audience engagement effortlessly.">
    <meta name="author" content="zophie">
    <meta name="theme-color" content="#764ba2">
    <link rel="canonical" href="https://my.ket.horse/stats">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://my.ket.horse/stats">
    <meta property="og:title" content="Advanced URL Statistics - my.ket.horse">
    <meta property="og:description" content="Track link performance, monitor clicks, and gauge audience engagement">
    <meta property="og:image" content="https://my.ket.horse/static/images/stats-banner.webp">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="Advanced URL Statistics - my.ket.horse">
    <meta property="twitter:description" content="Track link performance and analytics">
    <meta property="twitter:image" content="https://my.ket.horse/static/images/stats-banner.webp">

    <!-- Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/reset.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/design-system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/print.css') }}" media="print">
    <link rel="stylesheet" type="text/css" href="https://cdn.anychart.com/releases/8.12.1/css/anychart-ui.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.anychart.com/releases/8.12.1/fonts/css/anychart-font.min.css">

    <style>
        body {
            padding: var(--spacing-lg);
            min-height: 100vh;
        }

        .stats-header {
            max-width: 1200px;
            margin: 0 auto var(--spacing-xl) auto;
        }

        .stats-dashboard {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            gap: var(--spacing-lg);
        }

        .stats-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            border: 1px solid var(--glass-border);
            padding: var(--spacing-lg);
            box-shadow: var(--glass-shadow);
        }

        .stats-card h2 {
            font-size: 20px;
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-lg);
        }

        .stat-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
        }

        .stat-item p {
            margin: 0;
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-item code {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
            color: var(--accent-blue);
            word-break: break-all;
            max-width: 60%;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chart-container {
            position: relative;
            height: 350px;
            margin: var(--spacing-md) 0;
        }

        .chart-container canvas {
            max-height: 100%;
        }

        .chart-controls {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
            margin-top: var(--spacing-md);
        }

        .chart-controls select,
        .chart-controls button {
            padding: 8px 16px;
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .chart-controls select:hover,
        .chart-controls button:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .export-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        .export-button {
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--accent-purple);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .export-button:hover {
            background: var(--gradient-accent-2);
            transform: translateY(-2px);
        }

        .qr-code-container {
            text-align: center;
            margin-top: var(--spacing-md);
        }

        .qr-code-container img {
            border-radius: var(--radius-md);
            max-width: 200px;
            cursor: pointer;
            transition: transform var(--transition-base);
        }

        .qr-code-container img:hover {
            transform: scale(1.05);
        }

        .json-data {
            background: rgba(0, 0, 0, 0.4);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            overflow-x: auto;
            font-size: 12px;
            display: none;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            color: var(--accent-blue);
            text-decoration: none;
            font-weight: 600;
            margin-bottom: var(--spacing-lg);
        }

        .back-link:hover {
            color: var(--accent-purple);
        }

        @media (max-width: 768px) {
            body {
                padding: var(--spacing-md);
            }

            .chart-container {
                height: 250px;
            }

            .chart-controls {
                flex-direction: column;
            }

            .chart-controls select,
            .chart-controls button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="stats-header">
        <a href="/stats" class="back-link">
            ‚Üê Back to Stats Lookup
        </a>
    </div>

    <div class="stats-dashboard">
        <!-- General Stats Card -->
        <div class="stats-card">
            <h2>üìä General Statistics</h2>
            <div class="stats-grid">
                <div>
                    <div class="stat-item">
                        <p>Original URL <code id="url_long_code">{{ json_data['url'] }}</code></p>
                    </div>
                    <div class="stat-item">
                        <p>Short Code <code>{{ json_data["short_code"] }}</code></p>
                    </div>
                    <div class="stat-item">
                        <p>Creation Date <code>{{ json_data["creation-date"] }}</code></p>
                    </div>
                    {% if json_data["max-clicks"] %}
                    <div class="stat-item">
                        <p>Max Clicks <code>{{ json_data["max-clicks"] }}</code></p>
                    </div>
                    {% endif %}
                </div>
                <div>
                    <div class="stat-item">
                        <p>Total Clicks <code>{{ json_data["total-clicks"] }}</code></p>
                    </div>
                    <div class="stat-item">
                        <p>Unique Clicks <code>{{ json_data["total_unique_clicks"] }}</code></p>
                    </div>
                    <div class="stat-item">
                        <p>Last Click <code>{{ json_data['last-click'] }}</code></p>
                    </div>
                    {% if json_data["average_redirection_time"] > 0 %}
                    <div class="stat-item">
                        <p>Avg Redirection <code>{{ json_data["average_redirection_time"] }} ms</code></p>
                    </div>
                    {% endif %}
                </div>
                <div>
                    <div class="stat-item">
                        <p>Last Browser <code>{{ json_data["last-click-browser"] }}</code></p>
                    </div>
                    <div class="stat-item">
                        <p>Last OS <code>{{ json_data["last-click-os"] }}</code></p>
                    </div>
                    {% if json_data["block-bots"] %}
                    <div class="stat-item">
                        <p>Block Bots <code>{{ json_data["block-bots"] }}</code></p>
                    </div>
                    {% endif %}
                    {% if json_data["expired"] %}
                    <div class="stat-item">
                        <p>Expired <code id="expire">{{ json_data["expired"] }}</code></p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Click Counter Card -->
        <div class="stats-card">
            <h2>üìà Click Counter</h2>
            <div class="chart-container">
                <canvas id="counterChart"></canvas>
                <pre class="counterJsonPre json-data"><code id="counterJson" class="language-json"></code></pre>
            </div>
            <div class="chart-controls">
                <select id="counterOption" onchange="updateCounterChart()" title="Counter Date Range">
                    <option value="last7days" selected>Last 7 Days</option>
                    <option value="last30days">Last 30 Days</option>
                    <option value="alltime">All Time</option>
                </select>
                <button onclick="toggleView('counter')">Toggle JSON</button>
                <select id="counterDataOption" onchange="updateCounterChart()" title="Counter Data Option">
                    <option value="collectiveData">Overall Clicks</option>
                    <option value="uniqueData">Unique Clicks</option>
                    <option value="compareBoth" selected>Compare Both</option>
                </select>
            </div>
        </div>

        <!-- Browsers and Platforms Grid -->
        <div class="stats-grid">
            <!-- Browsers Card -->
            <div class="stats-card">
                <h2>üåê Browsers</h2>
                <div class="chart-container">
                    <canvas id="browserChart"></canvas>
                    <pre class="browserJsonPre json-data"><code id="browserJson" class="language-json"></code></pre>
                </div>
                <div class="chart-controls">
                    <button onclick="toggleView('browser')">Toggle JSON</button>
                    <select id="browserDataOption" onchange="updateBrowserChart()" title="Browser Data Option">
                        <option value="collectiveData">Overall</option>
                        <option value="uniqueData">Unique</option>
                        <option value="compareBoth" selected>Both</option>
                    </select>
                </div>
            </div>

            <!-- Platforms Card -->
            <div class="stats-card">
                <h2>üíª Platforms</h2>
                <div class="chart-container">
                    <canvas id="osChart"></canvas>
                    <pre class="osJsonPre json-data"><code id="osJson" class="language-json"></code></pre>
                </div>
                <div class="chart-controls">
                    <button onclick="toggleView('os')">Toggle JSON</button>
                    <select id="osDataOption" onchange="updateOsChart()" title="OS Data Option">
                        <option value="collectiveData">Overall</option>
                        <option value="uniqueData">Unique</option>
                        <option value="compareBoth" selected>Both</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Referrers and Countries Grid -->
        <div class="stats-grid">
            <!-- Referrers Card -->
            <div class="stats-card">
                <h2>üîó Referrers</h2>
                <div class="chart-container">
                    <canvas id="referrerChart"></canvas>
                    <pre class="referrerJsonPre json-data"><code id="referrerJson" class="language-json"></code></pre>
                </div>
                <div class="chart-controls">
                    <button onclick="toggleView('referrer')">Toggle JSON</button>
                    <select id="referrerDataOption" onchange="updateReferrerChart()" title="Referrer Data Option">
                        <option value="collectiveData" selected>Overall</option>
                        <option value="uniqueData">Unique</option>
                    </select>
                </div>
            </div>

            <!-- Countries Card -->
            <div class="stats-card">
                <h2>üåç Countries</h2>
                <div class="chart-container" id="country-container">
                    <div id="countryChart"></div>
                    <pre class="countryJsonPre json-data"><code id="countryJson" class="language-json"></code></pre>
                </div>
                <div class="chart-controls">
                    <button onclick="toggleView('country')">Toggle JSON</button>
                    <select id="countryDataOption" onchange="updateCountryChart()" title="Country Data Option">
                        <option value="collectiveData" selected>Overall</option>
                        <option value="uniqueData">Unique</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Bots and Analysis Grid -->
        <div class="stats-grid">
            <!-- Bots Card -->
            <div class="stats-card">
                <h2>ü§ñ Bot Clicks</h2>
                <div class="chart-container">
                    <canvas id="botsChart"></canvas>
                    <pre class="botsJsonPre json-data"><code id="botsJson" class="language-json"></code></pre>
                </div>
                <div class="chart-controls">
                    <button onclick="toggleView('bots')">Toggle JSON</button>
                </div>
            </div>

            <!-- Analysis Card -->
            <div class="stats-card">
                <h2>üìä Clicks Analysis</h2>
                <div class="chart-container">
                    <canvas id="analysisChart"></canvas>
                    <pre class="analysisJsonPre json-data"><code id="analysisJson" class="language-json"></code></pre>
                </div>
                <div class="chart-controls">
                    <button onclick="toggleView('analysis')">Toggle JSON</button>
                </div>
            </div>
        </div>

        <!-- Export and QR Code Card -->
        <div class="stats-card">
            <h2>üì• Export & QR Code</h2>
            <div class="stats-grid">
                <div>
                    <h3 style="font-size: 16px; margin-bottom: var(--spacing-md);">Export Data</h3>
                    <div class="export-grid">
                        <button class="export-button" onclick="exportData('json')">JSON</button>
                        <button class="export-button" onclick="exportData('csv')">CSV</button>
                        <button class="export-button" onclick="exportData('xml')">XML</button>
                        <button class="export-button" onclick="exportData('xlsx')">XLSX</button>
                    </div>
                </div>
                <div>
                    <h3 style="font-size: 16px; margin-bottom: var(--spacing-md); text-align: center;">QR Code</h3>
                    <div class="qr-code-container">
                        <img id="qrcode" alt="QR Code" src="https://qr.my.ket.horse/gradient?text={{ host_url }}{{ json_data['short_code'] }}" loading="lazy">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.anychart.com/releases/8.12.1/js/anychart-core.min.js"></script>
    <script src="https://cdn.anychart.com/releases/8.12.1/js/anychart-map.min.js"></script>
    <script src="https://cdn.anychart.com/releases/8.12.1/geodata/custom/world/world.js"></script>
    <script src="https://cdn.anychart.com/releases/8.12.1/js/anychart-data-adapter.min.js"></script>
    <script src="https://cdn.anychart.com/releases/8.12.1/js/anychart-exports.min.js"></script>
    <script src="https://cdn.anychart.com/releases/8.12.1/js/anychart-ui.min.js"></script>

    <script>
        const jsonResponse = {{ json_data| tojson }};

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show' + (isError ? ' toast-error' : ' toast-success');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        {% if json_data["expired"] %}
        function changeExpiredSpanColor() {
            var p = document.getElementById("expire");
            if (p.innerText === "True") {
                p.style.background = "rgba(255, 0, 0, 0.5)";
            }
            if (p.innerText === "False") {
                p.style.background = "rgba(0, 255, 0, 0.5)";
            }
        }
        window.onload = changeExpiredSpanColor;
        {% endif %}

        function toggleView(chartType) {
            const chartCanvas = document.getElementById(`${chartType}Chart`);
            const jsonPre = document.querySelector(`.${chartType}JsonPre`);
            const jsonDataElement = document.getElementById(`${chartType}Json`);

            if (chartType === 'analysis') {
                if (chartCanvas.style.display === 'none') {
                    chartCanvas.style.display = 'block';
                    jsonPre.style.display = 'none';
                } else {
                    chartCanvas.style.display = 'none';
                    jsonPre.style.display = 'block';
                    jsonDataElement.textContent = JSON.stringify(jsonResponse.analysis_data || {}, null, 2);
                }
            }
            else if (chartType === 'bots') {
                if (chartCanvas.style.display === 'none') {
                    chartCanvas.style.display = 'block';
                    jsonPre.style.display = 'none';
                } else {
                    chartCanvas.style.display = 'none';
                    jsonPre.style.display = 'block';
                    jsonDataElement.textContent = JSON.stringify(jsonResponse.bots || {}, null, 2);
                }
            }
            else if (chartType === 'counter') {
                if (chartCanvas.style.display === 'none') {
                    chartCanvas.style.display = 'block';
                    jsonPre.style.display = 'none';
                } else {
                    chartCanvas.style.display = 'none';
                    jsonPre.style.display = 'block';
                    const dataOption = document.getElementById(`${chartType}DataOption`).value;
                    const option = document.getElementById(`${chartType}Option`).value;

                    let dt = {}, dt2 = {};
                    switch (option) {
                        case 'last7days':
                            dt = getLastNDaysCounterData(jsonResponse.counter, 7);
                            dt2 = getLastNDaysCounterData(jsonResponse.unique_counter, 7);
                            break;
                        case 'last30days':
                            dt = getLastNDaysCounterData(jsonResponse.counter, 30);
                            dt2 = getLastNDaysCounterData(jsonResponse.unique_counter, 30);
                            break;
                        case 'alltime':
                            dt = jsonResponse.counter;
                            dt2 = jsonResponse.unique_counter;
                            break;
                        default:
                            dt = jsonResponse.counter;
                            dt2 = jsonResponse.unique_counter;
                    }

                    if (dataOption === "collectiveData") {
                        jsonDataElement.textContent = JSON.stringify(dt || {}, null, 2);
                    } else if (dataOption === "uniqueData") {
                        jsonDataElement.textContent = JSON.stringify(dt2 || {}, null, 2);
                    } else {
                        jsonDataElement.textContent = JSON.stringify({"collectiveData": dt, "uniqueData": dt2}, null, 2);
                    }
                }
            }
            else {
                if (chartCanvas.style.display === 'none') {
                    chartCanvas.style.display = 'block';
                    jsonPre.style.display = 'none';
                    if (chartType === 'country') {
                        document.getElementById("country-container").style.padding = "";
                    }
                } else {
                    chartCanvas.style.display = 'none';
                    jsonPre.style.display = 'block';
                    const dataOption = document.getElementById(`${chartType}DataOption`).value;
                    if (dataOption === "collectiveData")
                        jsonDataElement.textContent = JSON.stringify(jsonResponse[chartType] || {}, null, 2);
                    else if (dataOption === "uniqueData")
                        jsonDataElement.textContent = JSON.stringify(jsonResponse['unique_' + chartType] || {}, null, 2);
                    else
                        jsonDataElement.textContent = JSON.stringify({"collectiveData": jsonResponse[chartType] || {}, "uniqueData": jsonResponse['unique_' + chartType] || {}}, null, 2);

                    if (chartType === 'country') {
                        document.getElementById("country-container").style.padding = "20px";
                    }
                }
            }
        }

        function getLastNDaysCounterData(counterData, days) {
            const counterKeys = Object.keys(counterData);
            const lastNDaysKeys = counterKeys.slice(-days);
            const lastNDaysCounterData = {};
            lastNDaysKeys.forEach((key) => {
                lastNDaysCounterData[key] = counterData[key];
            });
            return lastNDaysCounterData;
        }

        function updateCounterChart() {
            const counterChartCanvas = document.getElementById('counterChart');
            if (counterChartCanvas.style.display === 'none') toggleView('counter');
            if (counterChartCanvas.chart) counterChartCanvas.chart.destroy();

            const dataOption = document.getElementById('counterDataOption').value;
            const option = document.getElementById('counterOption').value;

            let dt = {}, dt2 = {};
            switch (option) {
                case 'last7days':
                    dt = getLastNDaysCounterData(jsonResponse.counter, 7);
                    dt2 = getLastNDaysCounterData(jsonResponse.unique_counter, 7);
                    break;
                case 'last30days':
                    dt = getLastNDaysCounterData(jsonResponse.counter, 30);
                    dt2 = getLastNDaysCounterData(jsonResponse.unique_counter, 30);
                    break;
                case 'alltime':
                    dt = jsonResponse.counter;
                    dt2 = jsonResponse.unique_counter;
                    break;
                default:
                    dt = jsonResponse.counter;
                    dt2 = jsonResponse.unique_counter;
            }

            let datasets = [];
            if (dataOption === "collectiveData") {
                datasets = [{
                    label: 'Click Counter',
                    data: Object.values(dt),
                    fill: 'start',
                    backgroundColor: 'rgba(255, 159, 64, 0.25)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 2,
                    tension: 0.3,
                }];
            } else if (dataOption === "uniqueData") {
                datasets = [{
                    label: 'Unique Click Counter',
                    data: Object.values(dt2),
                    fill: 'start',
                    backgroundColor: 'rgba(201, 203, 207, 0.25)',
                    borderColor: 'rgba(201, 203, 207, 1)',
                    borderWidth: 2,
                    tension: 0.3,
                }];
            } else {
                datasets = [
                    {
                        label: 'Click Counter',
                        data: Object.values(dt),
                        fill: 'start',
                        backgroundColor: 'rgba(255, 159, 64, 0.15)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                    },
                    {
                        label: 'Unique Click Counter',
                        data: Object.values(dt2),
                        fill: 'start',
                        backgroundColor: 'rgba(201, 203, 207, 0.25)',
                        borderColor: 'rgba(201, 203, 207, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                    }
                ];
            }

            const counterChart = new Chart(counterChartCanvas, {
                type: 'line',
                data: {
                    labels: Object.keys(dt),
                    datasets: datasets,
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: {color: '#fff'},
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {color: '#fff'},
                        },
                    },
                    plugins: {
                        legend: {
                            labels: {color: '#fff'},
                        },
                    },
                },
            });
            counterChartCanvas.chart = counterChart;
        }

        function updateOsChart() {
            const osChartCanvas = document.getElementById('osChart');
            if (osChartCanvas.style.display === 'none') toggleView('os');
            if (osChartCanvas.chart) osChartCanvas.chart.destroy();

            const dataOption = document.getElementById('osDataOption').value;
            let datasets = [];
            if (dataOption === "collectiveData") {
                datasets = [{
                    label: 'Platforms',
                    data: Object.values(jsonResponse.sorted_os_name),
                    backgroundColor: 'rgba(144, 238, 144, 0.15)',
                    borderColor: 'rgba(144, 238, 144, 1)',
                    borderWidth: 2,
                    borderRadius: 20,
                }];
            } else if (dataOption === "uniqueData") {
                datasets = [{
                    label: 'Unique Platforms',
                    data: Object.values(jsonResponse.sorted_unique_os_name),
                    backgroundColor: 'rgba(255, 69, 0, 0.25)',
                    borderColor: 'rgba(255, 69, 0, 1)',
                    borderWidth: 2,
                    borderRadius: 20,
                }];
            } else {
                datasets = [
                    {
                        label: 'Platforms',
                        data: Object.values(jsonResponse.sorted_os_name),
                        backgroundColor: 'rgba(144, 238, 144, 0.15)',
                        borderColor: 'rgba(144, 238, 144, 1)',
                        borderWidth: 2,
                        borderRadius: 20,
                    },
                    {
                        label: 'Unique Platforms',
                        data: Object.values(jsonResponse.sorted_unique_os_name),
                        backgroundColor: 'rgba(255, 69, 0, 0.25)',
                        borderColor: 'rgba(255, 69, 0, 0.9)',
                        borderWidth: 2,
                        borderRadius: 20,
                    }
                ];
            }

            const osChart = new Chart(osChartCanvas, {
                type: 'bar',
                data: {
                    labels: Object.keys(jsonResponse.sorted_os_name),
                    datasets: datasets,
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {ticks: {color: '#fff'}},
                        y: {stacked: true, ticks: {color: '#fff'}},
                    },
                    plugins: {
                        legend: {labels: {color: '#fff'}},
                    },
                },
            });
            osChartCanvas.chart = osChart;
        }

        function updateBrowserChart() {
            const browserChartCanvas = document.getElementById('browserChart');
            if (browserChartCanvas.style.display === 'none') toggleView('browser');
            if (browserChartCanvas.chart) browserChartCanvas.chart.destroy();

            const dataOption = document.getElementById('browserDataOption').value;
            let datasets = [];
            if (dataOption === "collectiveData") {
                datasets = [{
                    label: 'Browsers',
                    data: Object.values(jsonResponse.sorted_browser),
                    backgroundColor: 'rgba(153, 102, 255, 0.25)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 2,
                    borderRadius: 20,
                }];
            } else if (dataOption === "uniqueData") {
                datasets = [{
                    label: 'Unique Browsers',
                    data: Object.values(jsonResponse.sorted_unique_browser),
                    backgroundColor: 'rgba(255, 159, 64, 0.25)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 2,
                    borderRadius: 20,
                }];
            } else {
                datasets = [
                    {
                        label: 'Browsers',
                        data: Object.values(jsonResponse.sorted_browser),
                        backgroundColor: 'rgba(153, 102, 255, 0.15)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 2,
                        borderRadius: 20,
                    },
                    {
                        label: 'Unique Browsers',
                        data: Object.values(jsonResponse.sorted_unique_browser),
                        backgroundColor: 'rgba(255, 159, 64, 0.25)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        borderRadius: 20,
                    }
                ];
            }

            const browserChart = new Chart(browserChartCanvas, {
                type: 'bar',
                data: {
                    labels: Object.keys(jsonResponse.sorted_browser),
                    datasets: datasets,
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {ticks: {color: '#fff'}},
                        y: {stacked: true, ticks: {color: '#fff'}},
                    },
                    plugins: {
                        legend: {labels: {color: '#fff'}},
                    },
                },
            });
            browserChartCanvas.chart = browserChart;
        }

        function updateReferrerChart() {
            const referrerChartCanvas = document.getElementById('referrerChart');
            if (referrerChartCanvas.style.display === 'none') toggleView('referrer');
            if (referrerChartCanvas.chart) referrerChartCanvas.chart.destroy();

            const dataOption = document.getElementById('referrerDataOption').value;
            const dt = dataOption === "collectiveData" ? JSON.parse(jsonResponse.sorted_referrer) : JSON.parse(jsonResponse.sorted_unique_referrer);

            const referrerChart = new Chart(referrerChartCanvas, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(dt),
                    datasets: [{
                        label: 'Referrers',
                        data: Object.values(dt),
                        backgroundColor: ["rgba(128, 0, 128, 0.4)", "rgba(255, 0, 255, 0.4)", "rgba(153, 51, 255, 0.4)", "rgba(204, 153, 255, 0.4)", "rgba(230, 230, 250, 0.4)"],
                        borderColor: ["rgba(128, 0, 128, 1)", "rgba(255, 0, 255, 1)", "rgba(153, 51, 255, 1)", "rgba(204, 153, 255, 1)", "rgba(230, 230, 250, 1)"],
                        borderWidth: 2,
                        hoverOffset: 4,
                        borderRadius: 5,
                        spacing: 5,
                    }],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {labels: {color: '#fff', boxWidth: 12}},
                    },
                },
            });
            referrerChartCanvas.chart = referrerChart;
        }

        function updateCountryChart() {
            const countryChartCanvas = document.getElementById('countryChart');
            countryChartCanvas.textContent = '';
            document.getElementById('country-container').style.padding = "5px";

            if (countryChartCanvas.style.display === 'none') toggleView('country');

            const dataOption = document.getElementById('countryDataOption').value;
            const dt = dataOption === "collectiveData" ? jsonResponse.sorted_country : jsonResponse.sorted_unique_country;
            var map_title = dataOption === "collectiveData" ? "Countries Clicks Heatmap" : "Countries Unique Clicks Heatmap";

            var dataSet = anychart.data.set(dt);
            var map = anychart.map();
            map.geoData("anychart.maps.world");
            var series = map.choropleth(dataSet);
            series.colorScale(anychart.scales.linearColor("#f5e6f7", "#ba68c8", "#9c27b0", "#6a1b9a"));
            series.stroke('#9c27b0', 1, '5 2', 'round');
            series.hovered().fill(function (d) {return anychart.color.darken(d.sourceColor, 0.1);});
            series.tooltip().format(function(e){return "Clicks: <b>" + e.getData("value") + "</b>";});

            var title = map.title();
            title.enabled(true);
            title.text(map_title);
            title.fontColor("#ffffff");
            title.fontSize(12);
            title.padding(0, 0, 10, 0);

            map.tooltip().useHtml(true);
            map.colorRange().enabled(true);
            map.colorRange().orientation('bottom');
            map.colorRange().labels({'fontSize': 13, 'fontColor': 'white'});
            map.colorRange().stroke('');

            var grids = map.grids();
            grids.enabled(true);
            grids.stroke("#ffffff", 0.3, "5 2", "round");

            var marker = map.colorRange().marker();
            marker.size(7);

            map.interactivity().zoomOnMouseWheel(true);
            map.interactivity().keyboardZoomAndMove(true);
            map.interactivity().zoomOnDoubleClick(true);

            var zoomController = anychart.ui.zoom();
            zoomController.target(map);
            zoomController.render();

            map.container("countryChart");
            map.contextMenu(true);
            map.background().fill("rgba(255, 255, 255, 0)");

            map.contextMenu().itemsFormatter(function (items) {
                delete items["full-screen-separator"];
                delete items["about"];
                delete items["share-with"];
                delete items["print-chart"];
                return items;
            });

            map.draw();
        }

        function updateAnalysisChart() {
            const analysisChartCanvas = document.getElementById('analysisChart');
            if (analysisChartCanvas.chart) analysisChartCanvas.chart.destroy();

            const analysisChart = new Chart(analysisChartCanvas, {
                type: 'bar',
                data: {
                    labels: ['Daily', 'Weekly', 'Monthly'],
                    datasets: [{
                        label: 'Clicks Analysis',
                        data: [`{{ json_data["average_daily_clicks"]}}`, `{{ json_data["average_weekly_clicks"]}}`, `{{ json_data["average_monthly_clicks"]}}`],
                        backgroundColor: 'rgba(255, 205, 86, 0.25)',
                        borderColor: 'rgba(255, 205, 86, 1)',
                        borderWidth: 2,
                        borderRadius: 20,
                    }],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {ticks: {color: '#fff'}},
                        y: {ticks: {color: '#fff'}},
                    },
                    plugins: {
                        legend: {labels: {color: '#fff'}},
                    },
                },
            });
            analysisChartCanvas.chart = analysisChart;
        }

        function updateBotsChart() {
            const botsChartCanvas = document.getElementById('botsChart');
            if (botsChartCanvas.style.display === 'none') toggleView('bots');
            if (botsChartCanvas.chart) botsChartCanvas.chart.destroy();

            const botsChart = new Chart(botsChartCanvas, {
                type: 'bar',
                data: {
                    labels: Object.keys(jsonResponse.sorted_bots),
                    datasets: [{
                        label: 'Bots',
                        data: Object.values(jsonResponse.sorted_bots),
                        fill: 'start',
                        backgroundColor: 'rgba(239, 98, 148, 0.25)',
                        borderColor: 'rgba(239, 98, 148, 1)',
                        borderWidth: 2,
                        borderRadius: 20,
                    }],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'x',
                    scales: {
                        x: {ticks: {color: '#fff'}},
                        y: {ticks: {color: '#fff'}},
                    },
                    plugins: {
                        legend: {labels: {color: '#fff'}},
                    },
                },
            });
            botsChartCanvas.chart = botsChart;
        }

        function exportData(format) {
            let url = `{{ host_url }}export/{{ json_data['short_code'] }}/${format}`;
            if("{{ json_data['password'] }}") {
                url += `?password={{ json_data['password'] }}`;
            }

            fetch(url)
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    const tld = format === 'csv' ? 'zip' : format;
                    link.href = url;
                    link.download = `${format}-export-{{ json_data['short_code'] }}.${tld}`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    showToast('‚úÖ Export started!');
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('‚ùå Export failed', true);
                });
        }

        // Initialize all charts
        const updateChartFunctions = [
            updateCounterChart,
            updateOsChart,
            updateBrowserChart,
            updateReferrerChart,
            updateCountryChart,
            updateAnalysisChart,
            updateBotsChart
        ];

        updateChartFunctions.forEach((updateFunction) => {
            try {
                updateFunction();
            } catch (error) {
                console.error(`An error occurred while updating the chart in ${updateFunction.name}:`, error);
            }
        });

        // Show success message
        window.addEventListener('load', () => {
            setTimeout(() => {
                showToast('üìä Statistics loaded successfully!');
            }, 500);
        });
    </script>
</body>
</html>
